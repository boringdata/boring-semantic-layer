# Caching

Accelerate queries with intelligent caching powered by [xorq](https://xorq.dev). Configure caching in profiles for automatic cache invalidation and deterministic caching across sessions.

## Quick Start

Install with xorq support:

```bash
pip install 'boring-semantic-layer[xorq]'
```

Configure caching in your profile:

```yaml
# profiles.yml
production:
  type: postgres
  host: ${POSTGRES_HOST}
  database: ${POSTGRES_DB}
  cache:
    enabled: true
    storage: parquet
    path: /var/cache/bsl
```

Load profile with xorq backend:

```python
from boring_semantic_layer import load_profile, SemanticModel

# use_xorq_backend=True is required for caching
con = load_profile('production', use_xorq_backend=True)
flights = SemanticModel(table=con.table("flights"), ...)

# Queries automatically cached based on profile
result = flights.group_by("carrier").aggregate("count").execute()
```

**Important:** Caching requires `use_xorq_backend=True` when loading profiles.

## Profile Configuration

### Storage Options

```yaml
# Development - no caching
dev:
  type: duckdb
  database: ":memory:"
  cache:
    enabled: false

# Staging - parquet cache
staging:
  type: duckdb
  database: "staging.db"
  cache:
    enabled: true
    storage: parquet              # Persistent, auto-invalidates
    path: /tmp/bsl_cache

# Production - database cache
production:
  type: postgres
  host: ${POSTGRES_HOST}
  database: ${POSTGRES_DB}
  cache:
    enabled: true
    storage: source               # Cache in Postgres
```

**Storage types:**
- `parquet` - Persistent files, auto-invalidates âœ… Recommended
- `source` - Cache in database, auto-invalidates
- `parquet_snapshot` - Manual invalidation control
- `source_snapshot` - Database cache, manual control

### Caching Modes

Control when caching occurs:

```yaml
production:
  cache:
    enabled: true
    storage: parquet
    path: /var/cache/bsl
    mode: aggregate    # query, model, or aggregate
```

**`mode: query`** (default) - Cache individual queries
**`mode: model`** - Cache all queries from a model
**`mode: aggregate`** - Auto-cache at aggregations (best for dashboards/cubes)

## Usage

### Automatic Caching

```python
# Load profile with xorq backend (required for caching)
con = load_profile('production', use_xorq_backend=True)
flights = SemanticModel(table=con.table("flights"), ...)

# Automatically cached based on profile settings
result = flights.group_by("carrier").aggregate("count").execute()
```

### Override Per Query

```python
from xorq.caching import ParquetStorage
import xorq.api as xo

custom_storage = ParquetStorage(source=xo.connect(), relative_path="/cache")

# Override profile settings
query = flights.group_by("carrier").aggregate("count").cache(storage=custom_storage)
result = query.execute()
```

**Note:** Cache keys are deterministically generated by xorq based on query structure. The same query will always use the same cache key across sessions.

### Disable for Specific Query

```python
# Profile has caching enabled, but skip for this query
result = flights.filter(...).cache(enabled=False).execute()
```

## Auto-Invalidation

Parquet and source storage automatically detect data changes:

```python
query = flights.group_by("carrier").aggregate("count")

result1 = query.execute()  # Computes and caches
result2 = query.execute()  # Reads from cache
# ... external data update ...
result3 = query.execute()  # Detects change, recomputes
```

**Detection:** File modification time (DuckDB), table metadata (Postgres), data hash (in-memory)

## Cache Management

```bash
# Inspect cache
ls -lh /var/cache/bsl/

# Clear cache
rm -rf /var/cache/bsl/*

# Periodic cleanup (files older than 7 days)
find /var/cache/bsl -type f -mtime +7 -delete
```

## API Reference

### Profile Cache Config

```yaml
cache:
  enabled: true           # Enable caching
  storage: parquet        # parquet, source, parquet_snapshot, source_snapshot
  path: /var/cache/bsl   # Cache directory (for parquet)
  mode: aggregate        # query, model, or aggregate
```

### `.cache()` Method

```python
def cache(
    storage=None,         # Override profile storage
    enabled: bool = True, # Enable/disable
    mode: str = None,     # Override profile mode
)
```

Cache keys are deterministically generated by xorq based on query structure.

## Tips

1. Use `mode: aggregate` for data cubes and dashboards
2. Use `storage: parquet` for persistence across restarts
3. Disable caching in dev for fast iteration
4. Monitor cache size: `du -sh /var/cache/bsl`

## Learn More

- [xorq Documentation](https://docs.xorq.dev/)
- [Profile Management](./profile.md)
- [Examples](../../examples/xorq_advanced_features.py)
