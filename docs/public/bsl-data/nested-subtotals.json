{
  "markdown": "# Nested Subtotals\n\nCreate hierarchical aggregations with subtotals at multiple levels using the `nest` parameter. This pattern enables drill-down analysis where each row contains both summary metrics and nested breakdowns.\n\n## Overview\n\nThe nested subtotals pattern allows you to:\n\n- Generate subtotals at each level of a dimensional hierarchy in a single query\n- Create nested structures where each parent row contains child breakdowns\n- Avoid complex self-joins or ROLLUP queries\n- Build hierarchical data suitable for tree views and drill-down UIs\n\n## Setup\n\nCreate a sample order items dataset with temporal and categorical dimensions:\n\n```setup_data\nimport ibis\nfrom ibis import _\nfrom boring_semantic_layer import to_semantic_table\n\n# Create synthetic order items data\norder_items_data = ibis.memtable({\n    \"order_id\": [1001, 1002, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010,\n                 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1020,\n                 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030],\n    \"sale_price\": [45.99, 89.50, 120.00, 34.99, 67.80, 99.99, 54.50, 78.99, 150.00, 42.00,\n                   55.99, 72.50, 88.80, 110.00, 39.99, 95.00, 62.50, 81.99, 125.00, 48.50,\n                   66.99, 92.00, 105.50, 73.99, 58.80, 118.00, 84.50, 69.99, 135.00, 51.50],\n    \"status\": [\"shipped\", \"delivered\", \"shipped\", \"processing\", \"delivered\",\n               \"shipped\", \"cancelled\", \"delivered\", \"shipped\", \"processing\",\n               \"delivered\", \"shipped\", \"delivered\", \"processing\", \"shipped\",\n               \"cancelled\", \"delivered\", \"shipped\", \"delivered\", \"processing\",\n               \"shipped\", \"delivered\", \"shipped\", \"processing\", \"delivered\",\n               \"shipped\", \"cancelled\", \"delivered\", \"shipped\", \"processing\"],\n    \"created_year\": [2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022,\n                     2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023,\n                     2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024],\n    \"created_month\": [1, 1, 2, 2, 3, 3, 4, 4, 5, 5,\n                      1, 1, 2, 2, 3, 3, 4, 4, 5, 5,\n                      1, 1, 2, 2, 3, 3, 4, 4, 5, 5]\n})\n\n# Create semantic table with measures\norder_items = to_semantic_table(\n    order_items_data,\n    name=\"order_items\",\n).with_measures(\n    order_count=lambda t: t.count(),\n    total_sales=lambda t: t.sale_price.sum(),\n    avg_price=lambda t: t.sale_price.mean(),\n)\n```\n\n<collapsedcodeblock code-block=\"setup_data\" title=\"Setup: Create Order Items Data\"></collapsedcodeblock>\n\n## Year with Nested Month Subtotals\n\nCreate yearly totals with monthly breakdowns nested inside each year:\n\n```query_year_with_months\nfrom ibis import _\n\n# First aggregate by year and month to get monthly subtotals\nmonthly_data = (\n    order_items\n    .group_by(\"created_year\", \"created_month\")\n    .aggregate(\"order_count\", \"total_sales\")\n)\n\n# Then nest months within years\nresult = (\n    monthly_data\n    .group_by(\"created_year\")\n    .aggregate(\n        year_order_count=lambda t: t.order_count.sum(),\n        year_total_sales=lambda t: t.total_sales.sum(),\n        nest={\"by_month\": lambda t: t.group_by([\"created_month\", \"order_count\", \"total_sales\"]).order_by(\"created_month\")}\n    )\n    .order_by(\"created_year\")\n)\n```\n\n<bslquery code-block=\"query_year_with_months\"></bslquery>\n\n<note type=\"info\">\nEach year row contains a `by_month` array with all monthly subtotals for that year. The pattern is: aggregate at the finest level first, then nest at each parent level.\n</note>\n\n## Year with Nested Status Subtotals\n\nAlternative breakdown: nest order status within each year:\n\n```query_year_with_status\nfrom ibis import _\n\n# First aggregate by year and status\nstatus_data = (\n    order_items\n    .group_by(\"created_year\", \"status\")\n    .aggregate(\"order_count\", \"total_sales\", \"avg_price\")\n)\n\n# Then nest status within years\nresult = (\n    status_data\n    .group_by(\"created_year\")\n    .aggregate(\n        year_order_count=lambda t: t.order_count.sum(),\n        year_total_sales=lambda t: t.total_sales.sum(),\n        nest={\"by_status\": lambda t: t.group_by([\"status\", \"order_count\", \"total_sales\", \"avg_price\"]).order_by(_.total_sales.desc())}\n    )\n    .order_by(\"created_year\")\n)\n```\n\n<bslquery code-block=\"query_year_with_status\"></bslquery>\n\n## Multi-Level Nesting: Year > Month > Status\n\nCreate three-level hierarchy with nested subtotals:\n\n```query_multi_level\nfrom ibis import _\n\n# First aggregate at the finest level: year, month, status\ndetailed_data = (\n    order_items\n    .group_by(\"created_year\", \"created_month\", \"status\")\n    .aggregate(\"order_count\", \"total_sales\")\n)\n\n# Second level: nest status within month\nmonthly_with_status = (\n    detailed_data\n    .group_by(\"created_year\", \"created_month\")\n    .aggregate(\n        month_order_count=lambda t: t.order_count.sum(),\n        month_total_sales=lambda t: t.total_sales.sum(),\n        nest={\"by_status\": lambda t: t.group_by([\"status\", \"order_count\", \"total_sales\"])}\n    )\n)\n\n# Top level: nest months within year\nresult = (\n    monthly_with_status\n    .group_by(\"created_year\")\n    .aggregate(\n        year_order_count=lambda t: t.month_order_count.sum(),\n        year_total_sales=lambda t: t.month_total_sales.sum(),\n        nest={\"by_month\": lambda t: t.group_by([\"created_month\", \"month_order_count\", \"month_total_sales\", \"by_status\"]).order_by(\"created_month\")}\n    )\n    .order_by(\"created_year\")\n    .limit(3)\n)\n```\n\n<bslquery code-block=\"query_multi_level\"></bslquery>\n\n## Use Cases\n\n**Financial Reporting**: Create income statements with nested line items - show total revenue with product categories nested inside, each containing individual products.\n\n**Geographic Hierarchies**: Aggregate sales by region, with nested states, with nested cities, all in a single query result.\n\n**Time-Based Drill-Downs**: Show yearly summaries with monthly breakdowns nested inside, perfect for dashboard drill-down interactions.\n\n**Organizational Analysis**: Display department totals with nested team breakdowns, with nested individual employee details.\n\n## Key Takeaways\n\n- Use the `nest` parameter in `.aggregate()` to create hierarchical subtotals\n- Each parent row contains an array column with child-level breakdowns\n- Avoid complex SQL ROLLUP or self-join patterns\n- Nest multiple levels deep for complex hierarchies\n- Perfect for building tree views, expandable tables, and drill-down UIs\n\n## Next Steps\n\n- Learn about [Percentage of Total](/advanced/percentage-total) calculations\n- Explore [Advanced Nesting](/advanced/nesting) for more complex hierarchical patterns\n",
  "queries": {
    "setup_data": {
      "code": "import ibis\nfrom ibis import _\nfrom boring_semantic_layer import to_semantic_table\n\n# Create synthetic order items data\norder_items_data = ibis.memtable({\n    \"order_id\": [1001, 1002, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010,\n                 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1020,\n                 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030],\n    \"sale_price\": [45.99, 89.50, 120.00, 34.99, 67.80, 99.99, 54.50, 78.99, 150.00, 42.00,\n                   55.99, 72.50, 88.80, 110.00, 39.99, 95.00, 62.50, 81.99, 125.00, 48.50,\n                   66.99, 92.00, 105.50, 73.99, 58.80, 118.00, 84.50, 69.99, 135.00, 51.50],\n    \"status\": [\"shipped\", \"delivered\", \"shipped\", \"processing\", \"delivered\",\n               \"shipped\", \"cancelled\", \"delivered\", \"shipped\", \"processing\",\n               \"delivered\", \"shipped\", \"delivered\", \"processing\", \"shipped\",\n               \"cancelled\", \"delivered\", \"shipped\", \"delivered\", \"processing\",\n               \"shipped\", \"delivered\", \"shipped\", \"processing\", \"delivered\",\n               \"shipped\", \"cancelled\", \"delivered\", \"shipped\", \"processing\"],\n    \"created_year\": [2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022,\n                     2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023,\n                     2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024, 2024],\n    \"created_month\": [1, 1, 2, 2, 3, 3, 4, 4, 5, 5,\n                      1, 1, 2, 2, 3, 3, 4, 4, 5, 5,\n                      1, 1, 2, 2, 3, 3, 4, 4, 5, 5]\n})\n\n# Create semantic table with measures\norder_items = to_semantic_table(\n    order_items_data,\n    name=\"order_items\",\n).with_measures(\n    order_count=lambda t: t.count(),\n    total_sales=lambda t: t.sale_price.sum(),\n    avg_price=lambda t: t.sale_price.mean(),\n)",
      "sql": "SELECT\n  *\nFROM \"ibis_pandas_memtable_egm2ad5dqnfnraxz65qku7bj64\"",
      "table": {
        "columns": [
          "order_id",
          "sale_price",
          "status",
          "created_year",
          "created_month"
        ],
        "data": [
          [
            1001,
            45.99,
            "shipped",
            2022,
            1
          ],
          [
            1002,
            89.5,
            "delivered",
            2022,
            1
          ],
          [
            1003,
            120.0,
            "shipped",
            2022,
            2
          ],
          [
            1004,
            34.99,
            "processing",
            2022,
            2
          ],
          [
            1005,
            67.8,
            "delivered",
            2022,
            3
          ],
          [
            1006,
            99.99,
            "shipped",
            2022,
            3
          ],
          [
            1007,
            54.5,
            "cancelled",
            2022,
            4
          ],
          [
            1008,
            78.99,
            "delivered",
            2022,
            4
          ],
          [
            1009,
            150.0,
            "shipped",
            2022,
            5
          ],
          [
            1010,
            42.0,
            "processing",
            2022,
            5
          ],
          [
            1011,
            55.99,
            "delivered",
            2023,
            1
          ],
          [
            1012,
            72.5,
            "shipped",
            2023,
            1
          ],
          [
            1013,
            88.8,
            "delivered",
            2023,
            2
          ],
          [
            1014,
            110.0,
            "processing",
            2023,
            2
          ],
          [
            1015,
            39.99,
            "shipped",
            2023,
            3
          ],
          [
            1016,
            95.0,
            "cancelled",
            2023,
            3
          ],
          [
            1017,
            62.5,
            "delivered",
            2023,
            4
          ],
          [
            1018,
            81.99,
            "shipped",
            2023,
            4
          ],
          [
            1019,
            125.0,
            "delivered",
            2023,
            5
          ],
          [
            1020,
            48.5,
            "processing",
            2023,
            5
          ],
          [
            1021,
            66.99,
            "shipped",
            2024,
            1
          ],
          [
            1022,
            92.0,
            "delivered",
            2024,
            1
          ],
          [
            1023,
            105.5,
            "shipped",
            2024,
            2
          ],
          [
            1024,
            73.99,
            "processing",
            2024,
            2
          ],
          [
            1025,
            58.8,
            "delivered",
            2024,
            3
          ],
          [
            1026,
            118.0,
            "shipped",
            2024,
            3
          ],
          [
            1027,
            84.5,
            "cancelled",
            2024,
            4
          ],
          [
            1028,
            69.99,
            "delivered",
            2024,
            4
          ],
          [
            1029,
            135.0,
            "shipped",
            2024,
            5
          ],
          [
            1030,
            51.5,
            "processing",
            2024,
            5
          ]
        ]
      }
    },
    "query_year_with_months": {
      "code": "from ibis import _\n\n# First aggregate by year and month to get monthly subtotals\nmonthly_data = (\n    order_items\n    .group_by(\"created_year\", \"created_month\")\n    .aggregate(\"order_count\", \"total_sales\")\n)\n\n# Then nest months within years\nresult = (\n    monthly_data\n    .group_by(\"created_year\")\n    .aggregate(\n        year_order_count=lambda t: t.order_count.sum(),\n        year_total_sales=lambda t: t.total_sales.sum(),\n        nest={\"by_month\": lambda t: t.group_by([\"created_month\", \"order_count\", \"total_sales\"]).order_by(\"created_month\")}\n    )\n    .order_by(\"created_year\")\n)",
      "sql": "SELECT\n  *\nFROM (\n  SELECT\n    \"t2\".\"created_year\",\n    SUM(\"t2\".\"order_count\") AS \"year_order_count\",\n    SUM(\"t2\".\"total_sales\") AS \"year_total_sales\",\n    ARRAY_AGG(\n      {'created_month': \"t2\".\"created_month\", 'order_count': \"t2\".\"order_count\", 'total_sales': \"t2\".\"total_sales\"}\n    ) FILTER(WHERE\n      {'created_month': \"t2\".\"created_month\", 'order_count': \"t2\".\"order_count\", 'total_sales': \"t2\".\"total_sales\"} IS NOT NULL) AS \"by_month\"\n  FROM (\n    SELECT\n      *\n    FROM (\n      SELECT\n        \"t0\".\"created_year\",\n        \"t0\".\"created_month\",\n        COUNT(*) AS \"order_count\",\n        SUM(\"t0\".\"sale_price\") AS \"total_sales\"\n      FROM \"ibis_pandas_memtable_egm2ad5dqnfnraxz65qku7bj64\" AS \"t0\"\n      GROUP BY\n        1,\n        2\n    ) AS \"t1\"\n  ) AS \"t2\"\n  GROUP BY\n    1\n) AS \"t3\"\nORDER BY\n  \"t3\".\"created_year\" ASC",
      "table": {
        "columns": [
          "created_year",
          "year_order_count",
          "year_total_sales",
          "by_month"
        ],
        "data": [
          [
            2022,
            10,
            783.76,
            [
              {
                "created_month": 5,
                "order_count": 2,
                "total_sales": 192.0
              },
              {
                "created_month": 1,
                "order_count": 2,
                "total_sales": 135.49
              },
              {
                "created_month": 3,
                "order_count": 2,
                "total_sales": 167.79
              },
              {
                "created_month": 2,
                "order_count": 2,
                "total_sales": 154.99
              },
              {
                "created_month": 4,
                "order_count": 2,
                "total_sales": 133.49
              }
            ]
          ],
          [
            2023,
            10,
            780.27,
            [
              {
                "created_month": 4,
                "order_count": 2,
                "total_sales": 144.49
              },
              {
                "created_month": 5,
                "order_count": 2,
                "total_sales": 173.5
              },
              {
                "created_month": 2,
                "order_count": 2,
                "total_sales": 198.8
              },
              {
                "created_month": 3,
                "order_count": 2,
                "total_sales": 134.99
              },
              {
                "created_month": 1,
                "order_count": 2,
                "total_sales": 128.49
              }
            ]
          ],
          [
            2024,
            10,
            856.27,
            [
              {
                "created_month": 3,
                "order_count": 2,
                "total_sales": 176.8
              },
              {
                "created_month": 1,
                "order_count": 2,
                "total_sales": 158.99
              },
              {
                "created_month": 2,
                "order_count": 2,
                "total_sales": 179.49
              },
              {
                "created_month": 5,
                "order_count": 2,
                "total_sales": 186.5
              },
              {
                "created_month": 4,
                "order_count": 2,
                "total_sales": 154.49
              }
            ]
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-b6d632ce41808c89c947d44a17f65d59"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "created_year",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "created_year",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "year_order_count",
                "year_total_sales",
                "by_month"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-b6d632ce41808c89c947d44a17f65d59": [
              {
                "created_year": 2023,
                "year_order_count": 10,
                "year_total_sales": 780.27,
                "by_month": [
                  {
                    "created_month": 3,
                    "order_count": 2,
                    "total_sales": 134.99
                  },
                  {
                    "created_month": 2,
                    "order_count": 2,
                    "total_sales": 198.8
                  },
                  {
                    "created_month": 1,
                    "order_count": 2,
                    "total_sales": 128.49
                  },
                  {
                    "created_month": 4,
                    "order_count": 2,
                    "total_sales": 144.49
                  },
                  {
                    "created_month": 5,
                    "order_count": 2,
                    "total_sales": 173.5
                  }
                ]
              },
              {
                "created_year": 2022,
                "year_order_count": 10,
                "year_total_sales": 783.76,
                "by_month": [
                  {
                    "created_month": 3,
                    "order_count": 2,
                    "total_sales": 167.79
                  },
                  {
                    "created_month": 4,
                    "order_count": 2,
                    "total_sales": 133.49
                  },
                  {
                    "created_month": 1,
                    "order_count": 2,
                    "total_sales": 135.49
                  },
                  {
                    "created_month": 2,
                    "order_count": 2,
                    "total_sales": 154.99
                  },
                  {
                    "created_month": 5,
                    "order_count": 2,
                    "total_sales": 192.0
                  }
                ]
              },
              {
                "created_year": 2024,
                "year_order_count": 10,
                "year_total_sales": 856.27,
                "by_month": [
                  {
                    "created_month": 5,
                    "order_count": 2,
                    "total_sales": 186.5
                  },
                  {
                    "created_month": 4,
                    "order_count": 2,
                    "total_sales": 154.49
                  },
                  {
                    "created_month": 1,
                    "order_count": 2,
                    "total_sales": 158.99
                  },
                  {
                    "created_month": 2,
                    "order_count": 2,
                    "total_sales": 179.49
                  },
                  {
                    "created_month": 3,
                    "order_count": 2,
                    "total_sales": 176.8
                  }
                ]
              }
            ]
          }
        }
      }
    },
    "query_year_with_status": {
      "code": "from ibis import _\n\n# First aggregate by year and status\nstatus_data = (\n    order_items\n    .group_by(\"created_year\", \"status\")\n    .aggregate(\"order_count\", \"total_sales\", \"avg_price\")\n)\n\n# Then nest status within years\nresult = (\n    status_data\n    .group_by(\"created_year\")\n    .aggregate(\n        year_order_count=lambda t: t.order_count.sum(),\n        year_total_sales=lambda t: t.total_sales.sum(),\n        nest={\"by_status\": lambda t: t.group_by([\"status\", \"order_count\", \"total_sales\", \"avg_price\"]).order_by(_.total_sales.desc())}\n    )\n    .order_by(\"created_year\")\n)",
      "sql": "SELECT\n  *\nFROM (\n  SELECT\n    \"t2\".\"created_year\",\n    SUM(\"t2\".\"order_count\") AS \"year_order_count\",\n    SUM(\"t2\".\"total_sales\") AS \"year_total_sales\",\n    ARRAY_AGG(\n      {'status': \"t2\".\"status\", 'order_count': \"t2\".\"order_count\", 'total_sales': \"t2\".\"total_sales\", 'avg_price': \"t2\".\"avg_price\"}\n    ) FILTER(WHERE\n      {'status': \"t2\".\"status\", 'order_count': \"t2\".\"order_count\", 'total_sales': \"t2\".\"total_sales\", 'avg_price': \"t2\".\"avg_price\"} IS NOT NULL) AS \"by_status\"\n  FROM (\n    SELECT\n      *\n    FROM (\n      SELECT\n        \"t0\".\"created_year\",\n        \"t0\".\"status\",\n        COUNT(*) AS \"order_count\",\n        SUM(\"t0\".\"sale_price\") AS \"total_sales\",\n        AVG(\"t0\".\"sale_price\") AS \"avg_price\"\n      FROM \"ibis_pandas_memtable_egm2ad5dqnfnraxz65qku7bj64\" AS \"t0\"\n      GROUP BY\n        1,\n        2\n    ) AS \"t1\"\n  ) AS \"t2\"\n  GROUP BY\n    1\n) AS \"t3\"\nORDER BY\n  \"t3\".\"created_year\" ASC",
      "table": {
        "columns": [
          "created_year",
          "year_order_count",
          "year_total_sales",
          "by_status"
        ],
        "data": [
          [
            2022,
            10,
            783.76,
            [
              {
                "status": "shipped",
                "order_count": 4,
                "total_sales": 415.98,
                "avg_price": 103.995
              },
              {
                "status": "cancelled",
                "order_count": 1,
                "total_sales": 54.5,
                "avg_price": 54.5
              },
              {
                "status": "processing",
                "order_count": 2,
                "total_sales": 76.99000000000001,
                "avg_price": 38.495000000000005
              },
              {
                "status": "delivered",
                "order_count": 3,
                "total_sales": 236.29000000000002,
                "avg_price": 78.76333333333334
              }
            ]
          ],
          [
            2023,
            10,
            780.27,
            [
              {
                "status": "cancelled",
                "order_count": 1,
                "total_sales": 95.0,
                "avg_price": 95.0
              },
              {
                "status": "processing",
                "order_count": 2,
                "total_sales": 158.5,
                "avg_price": 79.25
              },
              {
                "status": "delivered",
                "order_count": 4,
                "total_sales": 332.28999999999996,
                "avg_price": 83.07249999999999
              },
              {
                "status": "shipped",
                "order_count": 3,
                "total_sales": 194.48000000000002,
                "avg_price": 64.82666666666667
              }
            ]
          ],
          [
            2024,
            10,
            856.27,
            [
              {
                "status": "delivered",
                "order_count": 3,
                "total_sales": 220.79000000000002,
                "avg_price": 73.59666666666668
              },
              {
                "status": "shipped",
                "order_count": 4,
                "total_sales": 425.49,
                "avg_price": 106.3725
              },
              {
                "status": "processing",
                "order_count": 2,
                "total_sales": 125.49,
                "avg_price": 62.745
              },
              {
                "status": "cancelled",
                "order_count": 1,
                "total_sales": 84.5,
                "avg_price": 84.5
              }
            ]
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-2725bfeefba67cda937ec1bdbb2a72b2"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "created_year",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "created_year",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "year_order_count",
                "year_total_sales",
                "by_status"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-2725bfeefba67cda937ec1bdbb2a72b2": [
              {
                "created_year": 2023,
                "year_order_count": 10,
                "year_total_sales": 780.27,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 4,
                    "total_sales": 332.28999999999996,
                    "avg_price": 83.07249999999999
                  },
                  {
                    "status": "processing",
                    "order_count": 2,
                    "total_sales": 158.5,
                    "avg_price": 79.25
                  },
                  {
                    "status": "cancelled",
                    "order_count": 1,
                    "total_sales": 95.0,
                    "avg_price": 95.0
                  },
                  {
                    "status": "shipped",
                    "order_count": 3,
                    "total_sales": 194.48000000000002,
                    "avg_price": 64.82666666666667
                  }
                ]
              },
              {
                "created_year": 2024,
                "year_order_count": 10,
                "year_total_sales": 856.27,
                "by_status": [
                  {
                    "status": "cancelled",
                    "order_count": 1,
                    "total_sales": 84.5,
                    "avg_price": 84.5
                  },
                  {
                    "status": "processing",
                    "order_count": 2,
                    "total_sales": 125.49,
                    "avg_price": 62.745
                  },
                  {
                    "status": "shipped",
                    "order_count": 4,
                    "total_sales": 425.49,
                    "avg_price": 106.3725
                  },
                  {
                    "status": "delivered",
                    "order_count": 3,
                    "total_sales": 220.79000000000002,
                    "avg_price": 73.59666666666668
                  }
                ]
              },
              {
                "created_year": 2022,
                "year_order_count": 10,
                "year_total_sales": 783.76,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 3,
                    "total_sales": 236.29000000000002,
                    "avg_price": 78.76333333333334
                  },
                  {
                    "status": "shipped",
                    "order_count": 4,
                    "total_sales": 415.98,
                    "avg_price": 103.995
                  },
                  {
                    "status": "processing",
                    "order_count": 2,
                    "total_sales": 76.99000000000001,
                    "avg_price": 38.495000000000005
                  },
                  {
                    "status": "cancelled",
                    "order_count": 1,
                    "total_sales": 54.5,
                    "avg_price": 54.5
                  }
                ]
              }
            ]
          }
        }
      }
    },
    "query_multi_level": {
      "code": "from ibis import _\n\n# First aggregate at the finest level: year, month, status\ndetailed_data = (\n    order_items\n    .group_by(\"created_year\", \"created_month\", \"status\")\n    .aggregate(\"order_count\", \"total_sales\")\n)\n\n# Second level: nest status within month\nmonthly_with_status = (\n    detailed_data\n    .group_by(\"created_year\", \"created_month\")\n    .aggregate(\n        month_order_count=lambda t: t.order_count.sum(),\n        month_total_sales=lambda t: t.total_sales.sum(),\n        nest={\"by_status\": lambda t: t.group_by([\"status\", \"order_count\", \"total_sales\"])}\n    )\n)\n\n# Top level: nest months within year\nresult = (\n    monthly_with_status\n    .group_by(\"created_year\")\n    .aggregate(\n        year_order_count=lambda t: t.month_order_count.sum(),\n        year_total_sales=lambda t: t.month_total_sales.sum(),\n        nest={\"by_month\": lambda t: t.group_by([\"created_month\", \"month_order_count\", \"month_total_sales\", \"by_status\"]).order_by(\"created_month\")}\n    )\n    .order_by(\"created_year\")\n    .limit(3)\n)",
      "sql": "SELECT\n  *\nFROM (\n  SELECT\n    \"t4\".\"created_year\",\n    SUM(\"t4\".\"month_order_count\") AS \"year_order_count\",\n    SUM(\"t4\".\"month_total_sales\") AS \"year_total_sales\",\n    ARRAY_AGG(\n      {'created_month': \"t4\".\"created_month\", 'month_order_count': \"t4\".\"month_order_count\", 'month_total_sales': \"t4\".\"month_total_sales\", 'by_status': \"t4\".\"by_status\"}\n    ) FILTER(WHERE\n      {'created_month': \"t4\".\"created_month\", 'month_order_count': \"t4\".\"month_order_count\", 'month_total_sales': \"t4\".\"month_total_sales\", 'by_status': \"t4\".\"by_status\"} IS NOT NULL) AS \"by_month\"\n  FROM (\n    SELECT\n      *\n    FROM (\n      SELECT\n        \"t2\".\"created_year\",\n        \"t2\".\"created_month\",\n        SUM(\"t2\".\"order_count\") AS \"month_order_count\",\n        SUM(\"t2\".\"total_sales\") AS \"month_total_sales\",\n        ARRAY_AGG(\n          {'status': \"t2\".\"status\", 'order_count': \"t2\".\"order_count\", 'total_sales': \"t2\".\"total_sales\"}\n        ) FILTER(WHERE\n          {'status': \"t2\".\"status\", 'order_count': \"t2\".\"order_count\", 'total_sales': \"t2\".\"total_sales\"} IS NOT NULL) AS \"by_status\"\n      FROM (\n        SELECT\n          *\n        FROM (\n          SELECT\n            \"t0\".\"created_year\",\n            \"t0\".\"created_month\",\n            \"t0\".\"status\",\n            COUNT(*) AS \"order_count\",\n            SUM(\"t0\".\"sale_price\") AS \"total_sales\"\n          FROM \"ibis_pandas_memtable_egm2ad5dqnfnraxz65qku7bj64\" AS \"t0\"\n          GROUP BY\n            1,\n            2,\n            3\n        ) AS \"t1\"\n      ) AS \"t2\"\n      GROUP BY\n        1,\n        2\n    ) AS \"t3\"\n  ) AS \"t4\"\n  GROUP BY\n    1\n) AS \"t5\"\nORDER BY\n  \"t5\".\"created_year\" ASC\nLIMIT 3",
      "table": {
        "columns": [
          "created_year",
          "year_order_count",
          "year_total_sales",
          "by_month"
        ],
        "data": [
          [
            2022,
            10,
            783.76,
            [
              {
                "created_month": 1,
                "month_order_count": 2.0,
                "month_total_sales": 135.49,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 89.5
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 45.99
                  }
                ]
              },
              {
                "created_month": 2,
                "month_order_count": 2.0,
                "month_total_sales": 154.99,
                "by_status": [
                  {
                    "status": "processing",
                    "order_count": 1,
                    "total_sales": 34.99
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 120.0
                  }
                ]
              },
              {
                "created_month": 3,
                "month_order_count": 2.0,
                "month_total_sales": 167.79,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 67.8
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 99.99
                  }
                ]
              },
              {
                "created_month": 4,
                "month_order_count": 2.0,
                "month_total_sales": 133.49,
                "by_status": [
                  {
                    "status": "cancelled",
                    "order_count": 1,
                    "total_sales": 54.5
                  },
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 78.99
                  }
                ]
              },
              {
                "created_month": 5,
                "month_order_count": 2.0,
                "month_total_sales": 192.0,
                "by_status": [
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 150.0
                  },
                  {
                    "status": "processing",
                    "order_count": 1,
                    "total_sales": 42.0
                  }
                ]
              }
            ]
          ],
          [
            2023,
            10,
            780.27,
            [
              {
                "created_month": 3,
                "month_order_count": 2.0,
                "month_total_sales": 134.99,
                "by_status": [
                  {
                    "status": "cancelled",
                    "order_count": 1,
                    "total_sales": 95.0
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 39.99
                  }
                ]
              },
              {
                "created_month": 5,
                "month_order_count": 2.0,
                "month_total_sales": 173.5,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 125.0
                  },
                  {
                    "status": "processing",
                    "order_count": 1,
                    "total_sales": 48.5
                  }
                ]
              },
              {
                "created_month": 2,
                "month_order_count": 2.0,
                "month_total_sales": 198.8,
                "by_status": [
                  {
                    "status": "processing",
                    "order_count": 1,
                    "total_sales": 110.0
                  },
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 88.8
                  }
                ]
              },
              {
                "created_month": 4,
                "month_order_count": 2.0,
                "month_total_sales": 144.49,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 62.5
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 81.99
                  }
                ]
              },
              {
                "created_month": 1,
                "month_order_count": 2.0,
                "month_total_sales": 128.49,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 55.99
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 72.5
                  }
                ]
              }
            ]
          ],
          [
            2024,
            10,
            856.27,
            [
              {
                "created_month": 4,
                "month_order_count": 2.0,
                "month_total_sales": 154.49,
                "by_status": [
                  {
                    "status": "cancelled",
                    "order_count": 1,
                    "total_sales": 84.5
                  },
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 69.99
                  }
                ]
              },
              {
                "created_month": 1,
                "month_order_count": 2.0,
                "month_total_sales": 158.99,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 92.0
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 66.99
                  }
                ]
              },
              {
                "created_month": 5,
                "month_order_count": 2.0,
                "month_total_sales": 186.5,
                "by_status": [
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 135.0
                  },
                  {
                    "status": "processing",
                    "order_count": 1,
                    "total_sales": 51.5
                  }
                ]
              },
              {
                "created_month": 2,
                "month_order_count": 2.0,
                "month_total_sales": 179.49,
                "by_status": [
                  {
                    "status": "processing",
                    "order_count": 1,
                    "total_sales": 73.99
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 105.5
                  }
                ]
              },
              {
                "created_month": 3,
                "month_order_count": 2.0,
                "month_total_sales": 176.8,
                "by_status": [
                  {
                    "status": "delivered",
                    "order_count": 1,
                    "total_sales": 58.8
                  },
                  {
                    "status": "shipped",
                    "order_count": 1,
                    "total_sales": 118.0
                  }
                ]
              }
            ]
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-e7af64c455089e4e11fac464ecb95b10"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "created_year",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "created_year",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "year_order_count",
                "year_total_sales",
                "by_month"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-e7af64c455089e4e11fac464ecb95b10": [
              {
                "created_year": 2022,
                "year_order_count": 10,
                "year_total_sales": 783.76,
                "by_month": [
                  {
                    "created_month": 5,
                    "month_order_count": 2.0,
                    "month_total_sales": 192.0,
                    "by_status": [
                      {
                        "status": "processing",
                        "order_count": 1,
                        "total_sales": 42.0
                      },
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 150.0
                      }
                    ]
                  },
                  {
                    "created_month": 2,
                    "month_order_count": 2.0,
                    "month_total_sales": 154.99,
                    "by_status": [
                      {
                        "status": "processing",
                        "order_count": 1,
                        "total_sales": 34.99
                      },
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 120.0
                      }
                    ]
                  },
                  {
                    "created_month": 3,
                    "month_order_count": 2.0,
                    "month_total_sales": 167.79,
                    "by_status": [
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 99.99
                      },
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 67.8
                      }
                    ]
                  },
                  {
                    "created_month": 4,
                    "month_order_count": 2.0,
                    "month_total_sales": 133.49,
                    "by_status": [
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 78.99
                      },
                      {
                        "status": "cancelled",
                        "order_count": 1,
                        "total_sales": 54.5
                      }
                    ]
                  },
                  {
                    "created_month": 1,
                    "month_order_count": 2.0,
                    "month_total_sales": 135.49,
                    "by_status": [
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 89.5
                      },
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 45.99
                      }
                    ]
                  }
                ]
              },
              {
                "created_year": 2024,
                "year_order_count": 10,
                "year_total_sales": 856.27,
                "by_month": [
                  {
                    "created_month": 3,
                    "month_order_count": 2.0,
                    "month_total_sales": 176.8,
                    "by_status": [
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 58.8
                      },
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 118.0
                      }
                    ]
                  },
                  {
                    "created_month": 1,
                    "month_order_count": 2.0,
                    "month_total_sales": 158.99,
                    "by_status": [
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 66.99
                      },
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 92.0
                      }
                    ]
                  },
                  {
                    "created_month": 4,
                    "month_order_count": 2.0,
                    "month_total_sales": 154.49,
                    "by_status": [
                      {
                        "status": "cancelled",
                        "order_count": 1,
                        "total_sales": 84.5
                      },
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 69.99
                      }
                    ]
                  },
                  {
                    "created_month": 5,
                    "month_order_count": 2.0,
                    "month_total_sales": 186.5,
                    "by_status": [
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 135.0
                      },
                      {
                        "status": "processing",
                        "order_count": 1,
                        "total_sales": 51.5
                      }
                    ]
                  },
                  {
                    "created_month": 2,
                    "month_order_count": 2.0,
                    "month_total_sales": 179.49,
                    "by_status": [
                      {
                        "status": "processing",
                        "order_count": 1,
                        "total_sales": 73.99
                      },
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 105.5
                      }
                    ]
                  }
                ]
              },
              {
                "created_year": 2023,
                "year_order_count": 10,
                "year_total_sales": 780.27,
                "by_month": [
                  {
                    "created_month": 2,
                    "month_order_count": 2.0,
                    "month_total_sales": 198.8,
                    "by_status": [
                      {
                        "status": "processing",
                        "order_count": 1,
                        "total_sales": 110.0
                      },
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 88.8
                      }
                    ]
                  },
                  {
                    "created_month": 5,
                    "month_order_count": 2.0,
                    "month_total_sales": 173.5,
                    "by_status": [
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 125.0
                      },
                      {
                        "status": "processing",
                        "order_count": 1,
                        "total_sales": 48.5
                      }
                    ]
                  },
                  {
                    "created_month": 3,
                    "month_order_count": 2.0,
                    "month_total_sales": 134.99,
                    "by_status": [
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 39.99
                      },
                      {
                        "status": "cancelled",
                        "order_count": 1,
                        "total_sales": 95.0
                      }
                    ]
                  },
                  {
                    "created_month": 1,
                    "month_order_count": 2.0,
                    "month_total_sales": 128.49,
                    "by_status": [
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 55.99
                      },
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 72.5
                      }
                    ]
                  },
                  {
                    "created_month": 4,
                    "month_order_count": 2.0,
                    "month_total_sales": 144.49,
                    "by_status": [
                      {
                        "status": "shipped",
                        "order_count": 1,
                        "total_sales": 81.99
                      },
                      {
                        "status": "delivered",
                        "order_count": 1,
                        "total_sales": 62.5
                      }
                    ]
                  }
                ]
              }
            ]
          }
        }
      }
    }
  },
  "files": {}
}